<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>九九乘法冒險島 (互動除錯版)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700&display=swap" rel="stylesheet"/>
  <style>
    html,body { height:100%; }
    body { margin:0; background:#87ceeb; font-family:'M PLUS Rounded 1c', sans-serif; }
    canvas { display:block; width:100vw; height:100vh; /* 由 CSS 控大小 */ }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // ========== 基礎：Canvas 尺寸與 DPR ==========
    function resizeCanvas() {
      const dpr = Math.max(window.devicePixelRatio || 1, 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width  = Math.round(rect.width  * dpr);
      canvas.height = Math.round(rect.height * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // 之後繪圖都用 CSS 像素座標
    }
    window.addEventListener('resize', resizeCanvas);

    // ========== 工具：圓角矩形 polyfill ==========
    function rr(ctx, x, y, w, h, r = 0) {
      const radii = typeof r === 'number' ? {tl:r, tr:r, br:r, bl:r} : (r || {tl:0,tr:0,br:0,bl:0});
      ctx.beginPath();
      ctx.moveTo(x + radii.tl, y);
      ctx.lineTo(x + w - radii.tr, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + radii.tr);
      ctx.lineTo(x + w, y + h - radii.br);
      ctx.quadraticCurveTo(x + w, y + h, x + w - radii.br, y + h);
      ctx.lineTo(x + radii.bl, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - radii.bl);
      ctx.lineTo(x, y + radii.tl);
      ctx.quadraticCurveTo(x, y, x + radii.tl, y);
    }

    // ========== 遊戲狀態 ==========
    let currentPage = 'home';
    let uiButtons = [];               // {id, x, y, width, height, label, value}
    let questionRange = 0;
    let currentQuestion = {};
    let answerButtons = [];
    let correctAnswersCount = 0;
    let score = 0;
    let isAnswerLocked = false;
    let feedbackMessage = '';
    let lastPointer = { x:0, y:0 };
    let hoverBtnId = null;
    let debugMsg = '';

    // ========== 文本 ==========
    function drawText(text, x, y, size, color, align='center', baseline='middle') {
      ctx.font = `bold ${size}px 'M PLUS Rounded 1c', sans-serif`;
      ctx.fillStyle = color;
      ctx.textAlign = align;
      ctx.textBaseline = baseline;
      ctx.fillText(text, x, y);
    }

    // ========== 畫面 ==========
    function drawHomePage() {
      ctx.fillStyle = '#66CDAA'; ctx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);
      drawText('九九乘法冒險島 (互動除錯版)', canvas.clientWidth/2, canvas.clientHeight*0.25, 28, '#003');
      const bw=220,bh=70, y1=canvas.clientHeight*0.6, y2=y1+bh+20;
      drawButton('開始冒險！', canvas.clientWidth/2, y1, bw, bh, '#FF69B4', '#fff', 'start');
      drawButton('排行榜(停用)', canvas.clientWidth/2, y2, bw, bh, '#17a2b8', '#fff', 'noop');
    }

    function drawSelectionPage() {
      ctx.fillStyle = '#FFD700'; ctx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);
      drawText('選擇你的乘法挑戰！', canvas.clientWidth/2, canvas.clientHeight*0.12, 28, '#5a3b00');

      uiButtons = [];
      const nums = [1,2,3,4,5,6,7,8,9,10,'混合'];
      const cols = canvas.clientWidth>800 ? 4 : 3;
      const bw = Math.floor((canvas.clientWidth*0.8)/cols);
      const bh = 60;
      const spacingX = bw + 20, spacingY = bh + 20;
      const startX = (canvas.clientWidth - (cols*spacingX - 20))/2 + bw/2;
      const startY = canvas.clientHeight*0.25;

      nums.forEach((num, i) => {
        const r = Math.floor(i/cols), c = i%cols;
        const x = startX + c*spacingX;
        const y = startY + r*spacingY;
        const label = (num==='混合') ? '混合' : `${num} 的乘法`;
        drawButton(label, x, y, bw, bh, '#4CAF50', '#fff', 'select', num);
      });
    }

    function drawPracticePage() {
      ctx.fillStyle = '#87CEFA'; ctx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);
      drawText(`${currentQuestion.num1} × ${currentQuestion.num2} = ?`, canvas.clientWidth/2, canvas.clientHeight*0.25, 48, '#003');

      // 答案按鈕
      const cols = canvas.clientWidth>700 ? 3 : 2;
      const bw=120, bh=60;
      const tw = cols*(bw+20)-20;
      const sx = (canvas.clientWidth - tw)/2 + bw/2;
      const sy = canvas.clientHeight*0.6;
      answerButtons.forEach((btn,i)=>{
        const r=Math.floor(i/cols), c=i%cols;
        const x = sx + c*(bw+20), y = sy + r*(bh+20);
        drawButton(String(btn.value), x, y, bw, bh, '#FFD700', '#5a3b00', 'answer', btn.correct);
        btn.x=x; btn.y=y; btn.width=bw; btn.height=bh;
      });

      drawText(`分數：${score}`, 20, 30, 18, '#fff', 'left');
      drawText(`進度：${correctAnswersCount}/20`, canvas.clientWidth-20, 30, 18, '#fff', 'right');
      if (feedbackMessage) drawText(feedbackMessage, canvas.clientWidth/2, canvas.clientHeight*0.42, 24, '#a00');
    }

    function drawButton(text, x, y, w, h, bgColor, fgColor, id, value=null) {
      // 背景
      ctx.save();
      ctx.shadowColor='rgba(0,0,0,0.25)'; ctx.shadowBlur=8; ctx.shadowOffsetX=3; ctx.shadowOffsetY=3;
      ctx.fillStyle = bgColor;
      rr(ctx, x - w/2, y - h/2, w, h, 14); ctx.fill();
      ctx.restore();

      // 文字
      drawText(text, x, y, 20, fgColor);

      // 註冊按鈕（僅當前頁面重繪時會刷新）
      uiButtons.push({ id, x, y, width:w, height:h, label:text, value });
    }

    // ========== 問題生成 ==========
    function generateNewQuestion() {
      let num1, num2, answer;
      if (questionRange === '混合') {
        num1 = Math.floor(Math.random()*10)+1;
        num2 = Math.floor(Math.random()*9)+1;
      } else {
        num1 = questionRange || 2; // 預設 2
        num2 = Math.floor(Math.random()*9)+1;
      }
      answer = num1*num2;
      currentQuestion = {num1, num2, answer};
      const wrong = new Set();
      while (wrong.size < 5) {
        let off = Math.floor(Math.random()*10)-5; if (off===0) off=1;
        const wa = answer + off;
        if (wa>0 && wa!==answer) wrong.add(wa);
      }
      // 隨機佈局
      const arr = [{value:answer, correct:true}, ...Array.from(wrong).map(v=>({value:v, correct:false}))];
      arr.sort(()=>Math.random()-0.5);
      answerButtons = arr;
      isAnswerLocked = false;
      feedbackMessage = '';
    }

    // ========== 命中測試 & 事件 ==========
    function getPointerInCanvas(evt){
      const rect = canvas.getBoundingClientRect();
      const dpr = Math.max(window.devicePixelRatio || 1, 1);
      // 我們已用 setTransform 做縮放，這裡回傳 CSS 像素座標即可
      const x = (evt.clientX - rect.left);
      const y = (evt.clientY - rect.top);
      return { x, y, dpr };
    }

    function hit(btn, x, y){
      return (x > btn.x - btn.width/2 && x < btn.x + btn.width/2 &&
              y > btn.y - btn.height/2 && y < btn.y + btn.height/2);
    }

    canvas.addEventListener('pointermove', (evt)=>{
      const {x,y} = getPointerInCanvas(evt);
      lastPointer = {x,y};
      hoverBtnId = null;
      for (const b of uiButtons) {
        if (hit(b, x, y)) { hoverBtnId = b.id + (b.value!==null?`(${b.value})`: ''); break; }
      }
    }, {passive:true});

    canvas.addEventListener('pointerdown', (evt)=>{
      const {x,y} = getPointerInCanvas(evt);
      lastPointer = {x,y};
      let handled = false;

      if (['home','selection','practice'].includes(currentPage)) {
        for (const b of uiButtons) {
          if (hit(b, x, y)) {
            debugMsg = `點到: ${b.id}${b.value!==null?`(${b.value})`:''} @ (${Math.round(x)},${Math.round(y)})`;
            switch (b.id) {
              case 'start':
                currentPage = 'selection';
                break;
              case 'select':
                questionRange = b.value;
                correctAnswersCount = 0;
                score = 0;
                generateNewQuestion();
                currentPage = 'practice';
                break;
              case 'answer':
                if (isAnswerLocked) break;
                isAnswerLocked = true;
                if (b.value === true) {
                  feedbackMessage = '太棒了！答對囉！';
                  score += 5;
                  correctAnswersCount++;
                } else {
                  feedbackMessage = '再想想看喔！';
                  score = Math.max(0, score - 2);
                }
                setTimeout(()=>{
                  if (correctAnswersCount >= 20) {
                    currentPage = 'home'; // 簡化：回首頁
                  } else {
                    generateNewQuestion();
                  }
                }, 600);
                break;
              case 'noop':
                // 排行榜停用，單純避免誤按
                break;
            }
            handled = true;
            break;
          }
        }
      }

      if (!handled) {
        debugMsg = `未命中 @ (${Math.round(x)},${Math.round(y)})`;
      }
    });

    // ========== 除錯疊圖 ==========
    function drawDebugOverlay(){
      // 滑鼠座標
      ctx.fillStyle = 'rgba(0,0,0,0.6)';
      rr(ctx, 8, 8, 260, 64, 8); ctx.fill();
      ctx.fillStyle = '#0f0';
      ctx.font = '12px monospace';
      ctx.textAlign = 'left'; ctx.textBaseline = 'top';
      ctx.fillText(`page: ${currentPage}`, 16, 14);
      ctx.fillText(`pointer: (${Math.round(lastPointer.x)}, ${Math.round(lastPointer.y)})`, 16, 30);
      ctx.fillText(`hover: ${hoverBtnId??'-'}  ${debugMsg?(' | '+debugMsg):''}`, 16, 46);

      // 高亮命中框
      if (hoverBtnId) {
        const b = uiButtons.find(btn => (btn.id + (btn.value!==null?`(${btn.value})`:'')) === hoverBtnId);
        if (b) {
          ctx.save();
          ctx.strokeStyle = '#00ffff';
          ctx.lineWidth = 2;
          rr(ctx, b.x - b.width/2, b.y - b.height/2, b.width, b.height, 14);
          ctx.stroke();
          ctx.restore();
        }
      }
    }

    // ========== 主繪圖 ==========
    function render() {
      ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
      uiButtons = []; // 每幀重建當前頁的按鈕清單

      switch (currentPage) {
        case 'home':      drawHomePage(); break;
        case 'selection': drawSelectionPage(); break;
        case 'practice':  drawPracticePage(); break;
      }

      drawDebugOverlay();
      requestAnimationFrame(render);
    }

    // ========== 啟動 ==========
    (function main(){
      resizeCanvas();
      // （這裡先不載 Tone / Firebase。若互動 OK，再逐步加回去）
      requestAnimationFrame(render);
    })();
  </script>
</body>
</html>
